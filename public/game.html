<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤” ìŠ¤ë¬´ê³ ê°œ í•˜ê¸°!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-green-50 to-purple-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        
        <!-- í—¤ë” -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸ¤” ìŠ¤ë¬´ê³ ê°œ í•˜ê¸°!</h1>
            <p class="text-gray-600">ìì—°ì— ëŒ€í•œ ê¶ê¸ˆí•¨ì„ ê¹Šì´ íƒêµ¬í•´ë³´ì„¸ìš”</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- ì™¼ìª½: ë©”ì¸ íƒêµ¬ ì˜ì—­ -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- í˜„ì¬ ì§ˆë¬¸ -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-semibold text-blue-600 mb-4">ì‹œì‘ ì§ˆë¬¸</h3>
                    <div id="currentQuestion" class="text-lg text-gray-800 p-4 bg-blue-50 rounded-lg">
                        <!-- URLì—ì„œ ì§ˆë¬¸ì„ ê°€ì ¸ì˜µë‹ˆë‹¤ -->
                        ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                    </div>
                </div>

                <!-- ë¡œë”© -->
                <div id="loading" class="hidden bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                    <div class="flex items-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-yellow-600 mr-3"></div>
                        <span class="text-yellow-700">AIê°€ íƒêµ¬ ì§ˆë¬¸ë“¤ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
                    </div>
                </div>

                <!-- Claude ìƒì„± ì§ˆë¬¸ ì„ íƒ -->
                <div id="claudeQuestions" class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-green-600 mb-4">ì–´ë–¤ ë°©í–¥ìœ¼ë¡œ íƒêµ¬í•´ë³¼ê¹Œìš”?</h3>
                    <div id="questionOptions" class="space-y-3">
                        <!-- ì—¬ê¸°ì— 5ê°œ ì§ˆë¬¸ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <!-- ì‚¬ìš©ì ë‹µë³€/ìƒê° ì…ë ¥ -->
                <div id="userAnswerSection" class="hidden bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-purple-600 mb-4">ì„ íƒí•œ ì§ˆë¬¸ì— ëŒ€í•´ ìƒê°í•´ë³´ì„¸ìš”</h3>
                    <div id="selectedQuestionDisplay" class="bg-purple-50 p-4 rounded-lg mb-4 text-purple-800"></div>
                    <textarea 
                        id="userAnswer" 
                        placeholder="ì—¬ê¸°ì— ë‹¹ì‹ ì˜ ìƒê°ì´ë‚˜ ë‹µë³€ì„ ì ì–´ì£¼ì„¸ìš”..."
                        class="w-full p-4 border-2 border-purple-200 rounded-lg focus:border-purple-400 focus:outline-none resize-none"
                        rows="4"
                    ></textarea>
                    <button 
                        onclick="submitAnswer()" 
                        class="mt-4 w-full bg-purple-500 text-white py-3 px-6 rounded-lg hover:bg-purple-600 transition-colors font-medium"
                    >
                        ë‹¤ìŒ ë‹¨ê³„ë¡œ!
                    </button>
                </div>

                <!-- ì‚¬ìš©ì ì§ˆë¬¸ ì…ë ¥ -->
                <div id="userQuestionSection" class="hidden bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-orange-600 mb-4">ì´ì œ ë‹¹ì‹ ì´ ì§ˆë¬¸í•´ë³´ì„¸ìš”!</h3>
                    <textarea 
                        id="userNewQuestion" 
                        placeholder="íƒêµ¬í•˜ë©´ì„œ ìƒˆë¡­ê²Œ ê¶ê¸ˆí•´ì§„ ê²ƒì„ ì§ˆë¬¸ìœ¼ë¡œ ë§Œë“¤ì–´ë³´ì„¸ìš”..."
                        class="w-full p-4 border-2 border-orange-200 rounded-lg focus:border-orange-400 focus:outline-none resize-none"
                        rows="3"
                    ></textarea>
                    <button 
                        onclick="submitUserQuestion()" 
                        class="mt-4 w-full bg-orange-500 text-white py-3 px-6 rounded-lg hover:bg-orange-600 transition-colors font-medium"
                    >
                        ì§ˆë¬¸ ì œì¶œí•˜ê³  ê³„ì† íƒêµ¬í•˜ê¸°!
                    </button>
                </div>

            </div>

            <!-- ì˜¤ë¥¸ìª½: ìŠ¤ë¬´ê³ ê°œ ì§„í–‰ ìƒí™© -->
            <div class="bg-white rounded-lg shadow-lg p-6 max-h-screen overflow-hidden flex flex-col">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">ğŸ¯ ìŠ¤ë¬´ê³ ê°œ ì§„í–‰ìƒí™©</h3>
                
                <div class="mb-4 text-sm text-gray-600">
                    <span>ì§„í–‰: </span>
                    <span id="currentStep" class="font-bold text-blue-600">1</span>
                    <span> / 20</span>
                </div>

                <div id="gameProgress" class="space-y-2 text-sm flex-1 overflow-y-auto max-h-96">
                    <div class="bg-blue-50 p-2 rounded-lg mb-2">
                        <div class="font-semibold text-blue-600 text-sm">ê³ ê°œ 1 (ì‹œì‘)</div>
                        <div class="text-blue-800 mt-1 text-xs leading-tight" id="step1">ê±°ë¯¸ëŠ” ì™œ ë¨¹ì–´?</div>
                    </div>
                    <!-- ì§„í–‰í•˜ë©´ì„œ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>

                <div class="mt-4 pt-4 border-t border-gray-200 flex-shrink-0">
                    <div class="text-xs text-gray-500">
                        ğŸ’¡ ìŠ¤ë¬´ê³ ê°œë¥¼ í†µí•´ ìì—°ì˜ ë¹„ë°€ì„ í•˜ë‚˜ì”© í’€ì–´ë³´ì„¸ìš”!
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Supabase ì„¤ì •
        const supabaseUrl = 'https://kcaxstyuejaecdaafijy.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtjYXhzdHl1ZWphZWNkYWFmaWp5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTExNzIwNjYsImV4cCI6MjA2Njc0ODA2Nn0.V__xaHzg5hbt2GpIBH1I4CegLx5Fp33cya-Jl93b6hE';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // ê²Œì„ ìƒíƒœ
        let sessionId = generateSessionId();
        let currentStepNumber = 1;
        let gameData = [];
function addToGameData(stepType, content) {
    gameData.push({
        step: currentStepNumber,
        type: stepType,
        content: content
    });
}

        // Claude API í˜¸ì¶œ (Vercel Function ì‚¬ìš©)
        async function callClaudeAPI(baseQuestion, previousQuestions = []) {
            try {
                const response = await fetch('/api/generate-questions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        baseQuestion,
                        previousQuestions,
                        stepNumber: currentStepNumber
                    })
                });

                if (!response.ok) {
                    throw new Error(`API ì˜¤ë¥˜: ${response.status}`);
                }

                return await response.json();

            } catch (error) {
                console.error('Claude API ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ ì‹œ ìƒ˜í”Œ ì§ˆë¬¸ ë°˜í™˜
                return {
                    questions: [
                        `${baseQuestion}ì™€ ê´€ë ¨í•´ì„œ ì§ì ‘ ê´€ì°°í•´ë³¼ ìˆ˜ ìˆëŠ” ê²ƒì€ ë¬´ì—‡ì¼ê¹Œìš”?`,
                        `ë‹¤ë¥¸ ë™ë¬¼ë“¤ì€ ì´ê²ƒê³¼ ì–´ë–»ê²Œ ë‹¤ë¥¼ê¹Œìš”?`,
                        `ì´ê²ƒì´ ìì—°ì—ì„œ í•˜ëŠ” ì—­í• ì€ ë¬´ì—‡ì¼ê¹Œìš”?`,
                        `ë§Œì•½ ì´ê²ƒì´ ì—†ë‹¤ë©´ ìƒíƒœê³„ëŠ” ì–´ë–»ê²Œ ë ê¹Œìš”?`,
                        `ì‚¬ëŒë“¤ì€ ì´ëŸ° ìì—°í˜„ìƒì„ ì–´ë–»ê²Œ ì—°êµ¬í•˜ê³  ìˆì„ê¹Œìš”?`
                    ]
                };
            }
        }

        // ì„¸ì…˜ ì´ˆê¸°í™” ë° ì²« ì§ˆë¬¸ë“¤ ìƒì„±
        async function initializeGame() {
            const initialQuestion = document.getElementById('currentQuestion').textContent;
            
            // Supabaseì— ì„¸ì…˜ ì €ì¥
            try {
                const { data, error } = await supabase
                    .from('exploration_sessions')
                    .insert([{
                        session_id: sessionId,
                        initial_question: initialQuestion
                    }]);

                if (error) throw error;
            } catch (error) {
                console.error('ì„¸ì…˜ ì €ì¥ ì˜¤ë¥˜:', error);
            }

            // ì²« ë²ˆì§¸ Claude ì§ˆë¬¸ë“¤ ìƒì„±
            await generateClaudeQuestions(initialQuestion, 1);
        }

        // Claude ì§ˆë¬¸ ìƒì„±
async function generateClaudeQuestions(baseQuestion, stepNumber) {
    document.getElementById('loading').classList.remove('hidden');

    // ì´ì „ ì§ˆë¬¸ë“¤ ìˆ˜ì§‘
    const previousQuestions = gameData
        .filter(item => item.type === 'claude_question' || item.type === 'user_question')
        .map(item => item.content);

    try {
        const result = await callClaudeAPI(baseQuestion, previousQuestions);
        await displayClaudeQuestions(result.questions, stepNumber);
                
                // Supabaseì— Claude ì§ˆë¬¸ë“¤ ì €ì¥
                const { error } = await supabase
                    .from('question_steps')
                    .insert([{
                        session_id: sessionId,
                        step_number: stepNumber,
                        step_type: 'claude_options',
                        content: JSON.stringify(result.questions)
                    }]);

                if (error) console.error('Claude ì§ˆë¬¸ ì €ì¥ ì˜¤ë¥˜:', error);

            } catch (error) {
                console.error('ì§ˆë¬¸ ìƒì„± ì˜¤ë¥˜:', error);
            }

            document.getElementById('loading').classList.add('hidden');
        }

        // Claude ì§ˆë¬¸ë“¤ í‘œì‹œ
        async function displayClaudeQuestions(questions, stepNumber) {
            const questionOptions = document.getElementById('questionOptions');
            questionOptions.innerHTML = '';

            questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'p-4 border-2 border-green-200 rounded-lg hover:border-green-400 cursor-pointer transition-colors';
                questionDiv.innerHTML = `
                    <input type="radio" name="claudeQuestion" id="cq${index}" value="${question}" class="mr-3">
                    <label for="cq${index}" class="cursor-pointer text-green-800">${question}</label>
                `;
                questionDiv.onclick = () => {
                    document.getElementById(`cq${index}`).checked = true;
                    selectClaudeQuestion(question, stepNumber);
                };
                questionOptions.appendChild(questionDiv);
            });
        }

        // Claude ì§ˆë¬¸ ì„ íƒ
        async function selectClaudeQuestion(question, stepNumber) {
    // ì—¬ê¸°ì— ì¶”ê°€
    addToGameData('claude_question', question);
    
    document.getElementById('selectedQuestionDisplay').textContent = question;
    document.getElementById('userAnswerSection').classList.remove('hidden');
    // ... ë‚˜ë¨¸ì§€ ê¸°ì¡´ ì½”ë“œ
            
            // Claude ì§ˆë¬¸ ì„ íƒì°½ ìˆ¨ê¸°ê¸°
            document.getElementById('claudeQuestions').classList.add('hidden');
            
            // ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸
            currentStepNumber++;
            addToProgress(`ê³ ê°œ ${currentStepNumber}`, question, 'green');
            
            // Supabaseì— ì„ íƒ ì €ì¥
            const { error } = await supabase
                .from('question_steps')
                .insert([{
                    session_id: sessionId,
                    step_number: currentStepNumber,
                    step_type: 'user_selection',
                    content: question
                }]);

            if (error) console.error('ì„ íƒ ì €ì¥ ì˜¤ë¥˜:', error);
        }

        // ë‹µë³€ ì œì¶œ
        async function submitAnswer() {
            const answer = document.getElementById('userAnswer').value.trim();
            if (!answer) {
                alert('ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸
            currentStepNumber++;
            addToProgress(`ê³ ê°œ ${currentStepNumber} (ë‚´ ìƒê°)`, answer, 'purple');

            // Supabaseì— ë‹µë³€ ì €ì¥
            const { error } = await supabase
                .from('question_steps')
                .insert([{
                    session_id: sessionId,
                    step_number: currentStepNumber,
                    step_type: 'user_answer',
                    content: answer
                }]);

            if (error) console.error('ë‹µë³€ ì €ì¥ ì˜¤ë¥˜:', error);

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('userAnswerSection').classList.add('hidden');
            document.getElementById('userAnswer').value = '';

            if (currentStepNumber >= 20) {
                showGameComplete();
            } else {
                document.getElementById('userQuestionSection').classList.remove('hidden');
            }
        }

        // ì‚¬ìš©ì ì§ˆë¬¸ ì œì¶œ
        async function submitUserQuestion() {
            const newQuestion = document.getElementById('userNewQuestion').value.trim();
            if (!newQuestion) {
                alert('ìƒˆë¡œìš´ ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸
            currentStepNumber++;
            addToProgress(`ê³ ê°œ ${currentStepNumber} (ë‚´ ì§ˆë¬¸)`, newQuestion, 'orange');

            // Supabaseì— ì‚¬ìš©ì ì§ˆë¬¸ ì €ì¥
            const { error } = await supabase
                .from('question_steps')
                .insert([{
                    session_id: sessionId,
                    step_number: currentStepNumber,
                    step_type: 'user_question',
                    content: newQuestion
                }]);

            if (error) console.error('ì‚¬ìš©ì ì§ˆë¬¸ ì €ì¥ ì˜¤ë¥˜:', error);

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('userQuestionSection').classList.add('hidden');
            document.getElementById('userNewQuestion').value = '';

            // ìƒˆë¡œìš´ Claude ì§ˆë¬¸ë“¤ ìƒì„± ë° í‘œì‹œ
            if (currentStepNumber < 20) {
                document.getElementById('claudeQuestions').classList.remove('hidden');
                await generateClaudeQuestions(newQuestion, currentStepNumber);
            } else {
                showGameComplete();
            }
        }

        // ì§„í–‰ìƒí™©ì— ì¶”ê°€ (ê°„ê²© ì¤„ì´ê³  í…ìŠ¤íŠ¸ ê¸¸ì´ ì¡°ì •)
        function addToProgress(stepTitle, content, color) {
            const progressDiv = document.getElementById('gameProgress');
            const stepDiv = document.createElement('div');
            stepDiv.className = `bg-${color}-50 p-2 rounded-lg mb-2`; // íŒ¨ë”©ê³¼ ë§ˆì§„ ì¤„ì„
            
            // í…ìŠ¤íŠ¸ ê¸¸ì´ ì¡°ì • (ë” ê¸´ í…ìŠ¤íŠ¸ë„ ë³´ì´ë„ë¡)
            const truncatedContent = content.length > 80 ? content.substring(0, 80) + '...' : content;
            
            stepDiv.innerHTML = `
                <div class="font-semibold text-${color}-600 text-sm">${stepTitle}</div>
                <div class="text-${color}-800 mt-1 text-xs leading-tight">${truncatedContent}</div>
            `;
            progressDiv.appendChild(stepDiv);
            
            // í˜„ì¬ ë‹¨ê³„ ì—…ë°ì´íŠ¸
            document.getElementById('currentStep').textContent = currentStepNumber;
            
            // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
            progressDiv.scrollTop = progressDiv.scrollHeight;
        }

        // ê²Œì„ ì™„ë£Œ
        function showGameComplete() {
            alert('ğŸ‰ ìŠ¤ë¬´ê³ ê°œ ì™„ì„±! í›Œë¥­í•œ íƒêµ¬ì˜€ìŠµë‹ˆë‹¤!');
            // ì™„ë£Œ ì²˜ë¦¬ ë¡œì§ ì¶”ê°€
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = function() {
            // URLì—ì„œ ì§ˆë¬¸ íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
            const urlParams = new URLSearchParams(window.location.search);
            const question = urlParams.get('q');
            
            if (question) {
                document.getElementById('currentQuestion').textContent = decodeURIComponent(question);
                document.getElementById('step1').textContent = decodeURIComponent(question);
                initializeGame();
            } else {
                document.getElementById('currentQuestion').textContent = 'ì§ˆë¬¸ì´ ì „ë‹¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì´ì „ í˜ì´ì§€ì—ì„œ ë‹¤ì‹œ ì‹œì‘í•´ì£¼ì„¸ìš”.';
            }
        };
    </script>
</body>
</html>
