<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스무고개 게임</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 flex gap-8">
        <!-- 메인 게임 영역 -->
        <div class="flex-1 max-w-2xl">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h1 class="text-2xl font-bold text-blue-600 mb-6">시작 질문</h1>
                
                <!-- 초기 질문 표시 -->
                <div class="bg-blue-50 p-4 rounded-lg mb-6">
                    <p id="initialQuestion" class="text-lg font-medium">질문을 불러오는 중...</p>
                </div>

                <!-- 게임 상태 -->
                <div id="gameState">
                    <div class="text-center py-12">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600 mx-auto mb-4"></div>
                        <p class="text-lg text-gray-600 font-semibold">질문을 생성하고 있는 중입니다...</p>
                        <p class="text-sm text-gray-500 mt-2">잠시만 기다려 주세요</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 진행 상황 사이드바 -->
        <div class="w-80 bg-white rounded-lg shadow-lg p-6">
            <div class="flex items-center gap-2 mb-4">
                <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center">
                    <span class="text-white text-sm">🎯</span>
                </div>
                <h2 class="text-lg font-bold">스무고개 진행상황</h2>
            </div>
            
            <div class="mb-4">
                <p class="text-sm text-gray-600">진행: <span id="progressCount">0</span> / 20</p>
            </div>

            <div id="progressList" class="space-y-2 max-h-[600px] overflow-y-auto">
                <!-- 진행 상황이 여기에 추가됨 -->
            </div>

            <div class="mt-6 p-4 bg-yellow-50 rounded-lg">
                <p class="text-sm text-yellow-800">💡 생각하고 탐구하며 답을 찾아가요!</p>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let currentStep = 0;
        let gameHistory = [];
        let initialQuestion = '';

        // 격려 멘트 목록
        const encouragements = [
            "와, 신선한 시각이에요! 🌟",
            "좋은 질문이네요! 👍",
            "재미있는 관점이에요! 💡",
            "창의적인 접근이에요! ✨",
            "멋진 생각이에요! 🎯",
            "호기심이 대단해요! 🔍",
            "깊이 있는 질문이네요! 🤔",
            "탐구 정신이 훌륭해요! 🌈"
        ];

        // 랜덤 격려 멘트
        function getRandomEncouragement() {
            return encouragements[Math.floor(Math.random() * encouragements.length)];
        }

        // URL에서 초기 질문 가져오기
        function getInitialQuestion() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('q') || '질문을 찾을 수 없습니다';
        }

        // 로딩 표시
        function showLoading(message = '질문을 생성하고 있는 중입니다...') {
            document.getElementById('gameState').innerHTML = `
                <div class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600 mx-auto mb-4"></div>
                    <p class="text-lg text-gray-600 font-semibold">${message}</p>
                    <p class="text-sm text-gray-500 mt-2">잠시만 기다려 주세요</p>
                </div>
            `;
        }

        // Claude API 호출 - 질문 생성
        async function generateQuestions(previousQuestion = null, userThought = null) {
            try {
                const response = await fetch('/api/generate-questions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        baseQuestion: initialQuestion,
                        previousQuestion: previousQuestion,
                        userThought: userThought,
                        previousQuestions: gameHistory.filter(h => h.type === 'question').map(h => h.question),
                        stepNumber: currentStep + 1
                    })
                });

                if (!response.ok) throw new Error(`API 오류: ${response.status}`);
                const data = await response.json();
                return data.questions || [];
            } catch (error) {
                console.error('질문 생성 실패:', error);
                return [
                    "이것의 구조는 어떻게 되어 있을까?",
                    "이것은 어떤 환경에 있을까?",
                    "이것과 비슷한 것은 무엇일까?",
                    "이것의 역할은 무엇일까?",
                    "이것은 어떻게 작동할까?"
                ];
            }
        }

        // 진행상황 업데이트
        function updateProgress() {
            document.getElementById('progressCount').textContent = currentStep;
            
            const progressList = document.getElementById('progressList');
            progressList.innerHTML = '';
            
            // 시작 질문
            const initialDiv = document.createElement('div');
            initialDiv.className = 'p-3 rounded bg-blue-100 border-2 border-blue-300';
            initialDiv.innerHTML = `<strong class="text-blue-800">시작 질문</strong><br><span class="text-blue-700">${initialQuestion}</span>`;
            progressList.appendChild(initialDiv);
            
            // 히스토리
            gameHistory.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'p-2 rounded text-sm';
                
                if (item.type === 'question') {
                    div.className += ' bg-green-100 text-green-800';
                    div.innerHTML = `<strong>고개 ${Math.floor(index/2) + 1} - 질문</strong><br>${item.question}`;
                } else if (item.type === 'thought') {
                    div.className += ' bg-purple-100 text-purple-800';
                    div.innerHTML = `<strong>내 생각</strong><br>${item.thought}`;
                }
                
                progressList.appendChild(div);
            });

            // 스크롤을 맨 아래로
            progressList.scrollTop = progressList.scrollHeight;
        }

        // 5개 선택지 표시
        function showQuestionChoices(questions) {
            const gameState = document.getElementById('gameState');
            
            gameState.innerHTML = `
                <h2 class="text-xl font-bold text-green-600 mb-4">어떤 방향으로 탐구해볼까요?</h2>
                <div class="space-y-3">
                    ${questions.map((q, index) => `
                        <button onclick='selectQuestion(\`${q.replace(/`/g, '\\`').replace(/'/g, "\\'")}\`)' 
                                class="w-full p-4 text-left border-2 border-green-200 rounded-lg hover:bg-green-50 hover:border-green-400 transition-colors">
                            ${q}
                        </button>
                    `).join('')}
                </div>
            `;
        }

        // 질문 선택 처리
        function selectQuestion(question) {
            currentStep++;
            gameHistory.push({
                type: 'question',
                question: question,
                step: currentStep
            });
            updateProgress();
            
            // 격려 멘트와 함께 생각 입력 화면 표시
            showThoughtInput(question);
        }

        // 사용자 생각 입력 화면
        function showThoughtInput(question) {
            const gameState = document.getElementById('gameState');
            const encouragement = getRandomEncouragement();
            
            gameState.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                        <p class="font-semibold text-green-800 mb-2">선택한 질문:</p>
                        <p class="text-green-700 text-lg">${question}</p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-5 rounded-lg border-2 border-yellow-300">
                        <p class="text-2xl font-bold text-orange-600 text-center mb-2">${encouragement}</p>
                        <p class="text-center text-gray-700">이 질문에 대해 어떻게 생각하나요?</p>
                    </div>
                    
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            이 질문에 대한 당신의 생각이나 추측을 자유롭게 적어보세요
                        </label>
                        <textarea 
                            id="userThought" 
                            rows="4" 
                            class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                            placeholder="예: 아마도... / 혹시... / 만약에... / 왜냐하면..."></textarea>
                        <button 
                            onclick="submitThought('${question.replace(/'/g, "\\'")})" 
                            class="w-full mt-3 bg-purple-500 text-white py-3 px-6 rounded-lg font-medium hover:bg-purple-600 transition-colors">
                            생각 제출하고 계속 탐구하기!
                        </button>
                    </div>
                </div>
            `;
        }

        // 생각 제출 처리
        async function submitThought(question) {
            const userThought = document.getElementById('userThought').value.trim();
            
            if (!userThought) {
                alert('생각을 입력해주세요!');
                return;
            }

            currentStep++;
            gameHistory.push({
                type: 'thought',
                thought: userThought,
                step: currentStep
            });
            updateProgress();
            
            // 새 질문들 생성
            showLoading('다음 탐구 질문을 생성하고 있는 중입니다...');
            const questions = await generateQuestions(question, userThought);
            showQuestionChoices(questions);
        }

        // 게임 초기화
        async function initializeGame() {
            initialQuestion = getInitialQuestion();
            document.getElementById('initialQuestion').textContent = initialQuestion;
            updateProgress();
            
            // 첫 질문들 생성
            const questions = await generateQuestions();
            showQuestionChoices(questions);
        }

        // 페이지 로드 시 게임 시작
        window.onload = initializeGame;
    </script>
</body>
</html>
