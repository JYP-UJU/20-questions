<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🤔 스무고개 하기!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-green-50 to-purple-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        
        <!-- 헤더 -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">🤔 스무고개 하기!</h1>
            <p class="text-gray-600">자연에 대한 궁금함을 깊이 탐구해보세요</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- 왼쪽: 메인 탐구 영역 -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- 현재 질문 -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-semibold text-blue-600 mb-4">시작 질문</h3>
                    <div id="currentQuestion" class="text-lg text-gray-800 p-4 bg-blue-50 rounded-lg">
                        <!-- URL에서 질문을 가져옵니다 -->
                        질문을 불러오는 중...
                    </div>
                </div>

                <!-- 로딩 -->
                <div id="loading" class="hidden bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                    <div class="flex items-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-yellow-600 mr-3"></div>
                        <span class="text-yellow-700">AI가 탐구 질문들을 생성하고 있습니다...</span>
                    </div>
                </div>

                <!-- Claude 생성 질문 선택 -->
                <div id="claudeQuestions" class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-green-600 mb-4">어떤 방향으로 탐구해볼까요?</h3>
                    <div id="questionOptions" class="space-y-3">
                        <!-- 여기에 5개 질문이 동적으로 생성됩니다 -->
                    </div>
                </div>

                <!-- 사용자 답변/생각 입력 -->
                <div id="userAnswerSection" class="hidden bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-purple-600 mb-4">선택한 질문에 대해 생각해보세요</h3>
                    <div id="selectedQuestionDisplay" class="bg-purple-50 p-4 rounded-lg mb-4 text-purple-800"></div>
                    <textarea 
                        id="userAnswer" 
                        placeholder="여기에 당신의 생각이나 답변을 적어주세요..."
                        class="w-full p-4 border-2 border-purple-200 rounded-lg focus:border-purple-400 focus:outline-none resize-none"
                        rows="4"
                    ></textarea>
                    <button 
                        onclick="submitAnswer()" 
                        class="mt-4 w-full bg-purple-500 text-white py-3 px-6 rounded-lg hover:bg-purple-600 transition-colors font-medium"
                    >
                        다음 단계로!
                    </button>
                </div>

                <!-- 사용자 질문 입력 -->
                <div id="userQuestionSection" class="hidden bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-orange-600 mb-4">이제 당신이 질문해보세요!</h3>
                    <textarea 
                        id="userNewQuestion" 
                        placeholder="탐구하면서 새롭게 궁금해진 것을 질문으로 만들어보세요..."
                        class="w-full p-4 border-2 border-orange-200 rounded-lg focus:border-orange-400 focus:outline-none resize-none"
                        rows="3"
                    ></textarea>
                    <button 
                        onclick="submitUserQuestion()" 
                        class="mt-4 w-full bg-orange-500 text-white py-3 px-6 rounded-lg hover:bg-orange-600 transition-colors font-medium"
                    >
                        질문 제출하고 계속 탐구하기!
                    </button>
                </div>

            </div>

            <!-- 오른쪽: 스무고개 진행 상황 -->
            <div class="bg-white rounded-lg shadow-lg p-6 max-h-screen overflow-hidden flex flex-col">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">🎯 스무고개 진행상황</h3>
                
                <div class="mb-4 text-sm text-gray-600">
                    <span>진행: </span>
                    <span id="currentStep" class="font-bold text-blue-600">1</span>
                    <span> / 20</span>
                </div>

                <div id="gameProgress" class="space-y-2 text-sm flex-1 overflow-y-auto max-h-96">
                    <div class="bg-blue-50 p-2 rounded-lg mb-2">
                        <div class="font-semibold text-blue-600 text-sm">고개 1 (시작)</div>
                        <div class="text-blue-800 mt-1 text-xs leading-tight" id="step1">거미는 왜 먹어?</div>
                    </div>
                    <!-- 진행하면서 동적으로 추가됩니다 -->
                </div>

                <div class="mt-4 pt-4 border-t border-gray-200 flex-shrink-0">
                    <div class="text-xs text-gray-500">
                        💡 스무고개를 통해 자연의 비밀을 하나씩 풀어보세요!
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Supabase 설정
        const supabaseUrl = 'https://kcaxstyuejaecdaafijy.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtjYXhzdHl1ZWphZWNkYWFmaWp5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTExNzIwNjYsImV4cCI6MjA2Njc0ODA2Nn0.V__xaHzg5hbt2GpIBH1I4CegLx5Fp33cya-Jl93b6hE';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // 게임 상태
        let sessionId = generateSessionId();
        let currentStepNumber = 1;
        let gameData = [];
function addToGameData(stepType, content) {
    gameData.push({
        step: currentStepNumber,
        type: stepType,
        content: content
    });
}

        // Claude API 호출 (Vercel Function 사용)
        async function callClaudeAPI(baseQuestion, previousQuestions = []) {
            try {
                const response = await fetch('/api/generate-questions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        baseQuestion,
                        previousQuestions,
                        stepNumber: currentStepNumber
                    })
                });

                if (!response.ok) {
                    throw new Error(`API 오류: ${response.status}`);
                }

                return await response.json();

            } catch (error) {
                console.error('Claude API 오류:', error);
                // 오류 시 샘플 질문 반환
                return {
                    questions: [
                        `${baseQuestion}와 관련해서 직접 관찰해볼 수 있는 것은 무엇일까요?`,
                        `다른 동물들은 이것과 어떻게 다를까요?`,
                        `이것이 자연에서 하는 역할은 무엇일까요?`,
                        `만약 이것이 없다면 생태계는 어떻게 될까요?`,
                        `사람들은 이런 자연현상을 어떻게 연구하고 있을까요?`
                    ]
                };
            }
        }

        // 세션 초기화 및 첫 질문들 생성
        async function initializeGame() {
            const initialQuestion = document.getElementById('currentQuestion').textContent;
            
            // Supabase에 세션 저장
            try {
                const { data, error } = await supabase
                    .from('exploration_sessions')
                    .insert([{
                        session_id: sessionId,
                        initial_question: initialQuestion
                    }]);

                if (error) throw error;
            } catch (error) {
                console.error('세션 저장 오류:', error);
            }

            // 첫 번째 Claude 질문들 생성
            await generateClaudeQuestions(initialQuestion, 1);
        }

        // Claude 질문 생성
async function generateClaudeQuestions(baseQuestion, stepNumber) {
    document.getElementById('loading').classList.remove('hidden');

    // 이전 질문들 수집
    const previousQuestions = gameData
        .filter(item => item.type === 'claude_question' || item.type === 'user_question')
        .map(item => item.content);

    try {
        const result = await callClaudeAPI(baseQuestion, previousQuestions);
        await displayClaudeQuestions(result.questions, stepNumber);
                
                // Supabase에 Claude 질문들 저장
                const { error } = await supabase
                    .from('question_steps')
                    .insert([{
                        session_id: sessionId,
                        step_number: stepNumber,
                        step_type: 'claude_options',
                        content: JSON.stringify(result.questions)
                    }]);

                if (error) console.error('Claude 질문 저장 오류:', error);

            } catch (error) {
                console.error('질문 생성 오류:', error);
            }

            document.getElementById('loading').classList.add('hidden');
        }

        // Claude 질문들 표시
        async function displayClaudeQuestions(questions, stepNumber) {
            const questionOptions = document.getElementById('questionOptions');
            questionOptions.innerHTML = '';

            questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'p-4 border-2 border-green-200 rounded-lg hover:border-green-400 cursor-pointer transition-colors';
                questionDiv.innerHTML = `
                    <input type="radio" name="claudeQuestion" id="cq${index}" value="${question}" class="mr-3">
                    <label for="cq${index}" class="cursor-pointer text-green-800">${question}</label>
                `;
                questionDiv.onclick = () => {
                    document.getElementById(`cq${index}`).checked = true;
                    selectClaudeQuestion(question, stepNumber);
                };
                questionOptions.appendChild(questionDiv);
            });
        }

        // Claude 질문 선택
        async function selectClaudeQuestion(question, stepNumber) {
    // 여기에 추가
    addToGameData('claude_question', question);
    
    document.getElementById('selectedQuestionDisplay').textContent = question;
    document.getElementById('userAnswerSection').classList.remove('hidden');
    // ... 나머지 기존 코드
            
            // Claude 질문 선택창 숨기기
            document.getElementById('claudeQuestions').classList.add('hidden');
            
            // 진행상황 업데이트
            currentStepNumber++;
            addToProgress(`고개 ${currentStepNumber}`, question, 'green');
            
            // Supabase에 선택 저장
            const { error } = await supabase
                .from('question_steps')
                .insert([{
                    session_id: sessionId,
                    step_number: currentStepNumber,
                    step_type: 'user_selection',
                    content: question
                }]);

            if (error) console.error('선택 저장 오류:', error);
        }

        // 답변 제출
        async function submitAnswer() {
            const answer = document.getElementById('userAnswer').value.trim();
            if (!answer) {
                alert('답변을 입력해주세요.');
                return;
            }

            // 진행상황 업데이트
            currentStepNumber++;
            addToProgress(`고개 ${currentStepNumber} (내 생각)`, answer, 'purple');

            // Supabase에 답변 저장
            const { error } = await supabase
                .from('question_steps')
                .insert([{
                    session_id: sessionId,
                    step_number: currentStepNumber,
                    step_type: 'user_answer',
                    content: answer
                }]);

            if (error) console.error('답변 저장 오류:', error);

            // UI 업데이트
            document.getElementById('userAnswerSection').classList.add('hidden');
            document.getElementById('userAnswer').value = '';

            if (currentStepNumber >= 20) {
                showGameComplete();
            } else {
                document.getElementById('userQuestionSection').classList.remove('hidden');
            }
        }

        // 사용자 질문 제출
        async function submitUserQuestion() {
            const newQuestion = document.getElementById('userNewQuestion').value.trim();
            if (!newQuestion) {
                alert('새로운 질문을 입력해주세요.');
                return;
            }

            // 진행상황 업데이트
            currentStepNumber++;
            addToProgress(`고개 ${currentStepNumber} (내 질문)`, newQuestion, 'orange');

            // Supabase에 사용자 질문 저장
            const { error } = await supabase
                .from('question_steps')
                .insert([{
                    session_id: sessionId,
                    step_number: currentStepNumber,
                    step_type: 'user_question',
                    content: newQuestion
                }]);

            if (error) console.error('사용자 질문 저장 오류:', error);

            // UI 업데이트
            document.getElementById('userQuestionSection').classList.add('hidden');
            document.getElementById('userNewQuestion').value = '';

            // 새로운 Claude 질문들 생성 및 표시
            if (currentStepNumber < 20) {
                document.getElementById('claudeQuestions').classList.remove('hidden');
                await generateClaudeQuestions(newQuestion, currentStepNumber);
            } else {
                showGameComplete();
            }
        }

        // 진행상황에 추가 (간격 줄이고 텍스트 길이 조정)
        function addToProgress(stepTitle, content, color) {
            const progressDiv = document.getElementById('gameProgress');
            const stepDiv = document.createElement('div');
            stepDiv.className = `bg-${color}-50 p-2 rounded-lg mb-2`; // 패딩과 마진 줄임
            
            // 텍스트 길이 조정 (더 긴 텍스트도 보이도록)
            const truncatedContent = content.length > 80 ? content.substring(0, 80) + '...' : content;
            
            stepDiv.innerHTML = `
                <div class="font-semibold text-${color}-600 text-sm">${stepTitle}</div>
                <div class="text-${color}-800 mt-1 text-xs leading-tight">${truncatedContent}</div>
            `;
            progressDiv.appendChild(stepDiv);
            
            // 현재 단계 업데이트
            document.getElementById('currentStep').textContent = currentStepNumber;
            
            // 스크롤을 맨 아래로
            progressDiv.scrollTop = progressDiv.scrollHeight;
        }

        // 게임 완료
        function showGameComplete() {
            alert('🎉 스무고개 완성! 훌륭한 탐구였습니다!');
            // 완료 처리 로직 추가
        }

        // 페이지 로드 시 초기화
        window.onload = function() {
            // URL에서 질문 파라미터 가져오기
            const urlParams = new URLSearchParams(window.location.search);
            const question = urlParams.get('q');
            
            if (question) {
                document.getElementById('currentQuestion').textContent = decodeURIComponent(question);
                document.getElementById('step1').textContent = decodeURIComponent(question);
                initializeGame();
            } else {
                document.getElementById('currentQuestion').textContent = '질문이 전달되지 않았습니다. 이전 페이지에서 다시 시작해주세요.';
            }
        };
    </script>
</body>
</html>
