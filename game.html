<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë¬´ê³ ê°œ ê²Œì„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .concept-card {
            transition: all 0.2s ease;
        }
        .concept-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }
        .concept-card.selected {
            background-color: #dcfce7;
            border-color: #16a34a;
            border-width: 3px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 flex gap-8">
        <!-- ë©”ì¸ ê²Œì„ ì˜ì—­ -->
        <div class="flex-1 max-w-2xl">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h1 class="text-2xl font-bold text-blue-600 mb-6">ì‹œì‘ ì§ˆë¬¸</h1>
                
                <!-- ì´ˆê¸° ì§ˆë¬¸ í‘œì‹œ -->
                <div class="bg-blue-50 p-4 rounded-lg mb-6">
                    <p id="initialQuestion" class="text-lg font-medium">ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>

                <!-- ê²©ë ¤ ë©˜íŠ¸ -->
                <div id="encouragementBox" class="hidden bg-gradient-to-r from-yellow-50 to-orange-50 p-5 rounded-lg border-2 border-yellow-300 mb-6">
                    <p class="text-2xl font-bold text-orange-600 text-center">ê¶ê¸ˆí•œ ê²Œ ìƒê²¼ë„¤ìš”! í•¨ê»˜ ì•Œì•„ê°€ë´ìš”! ğŸŒŸ</p>
                </div>

                <!-- ê²Œì„ ìƒíƒœ -->
                <div id="gameState">
                    <div class="text-center py-12">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600 mx-auto mb-4"></div>
                        <p class="text-lg text-gray-600 font-semibold">ì§ˆë¬¸ì„ ìƒì„±í•˜ê³  ìˆëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                        <p class="text-sm text-gray-500 mt-2">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”</p>
                    </div>
                </div>

                <!-- í•˜ë‹¨ ë²„íŠ¼ -->
                <div id="actionButtons" class="hidden mt-6 flex gap-3">
                    <button onclick="goBack()" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg font-medium hover:bg-gray-600 transition-colors">
                        ì´ì „ í™”ë©´
                    </button>
                    <button onclick="continueThinking()" class="flex-1 bg-blue-500 text-white py-3 px-6 rounded-lg font-medium hover:bg-blue-600 transition-colors">
                        ê³„ì† ìƒê°í•´ë³´ê¸°
                    </button>
                    <button onclick="summarize()" class="flex-1 bg-purple-500 text-white py-3 px-6 rounded-lg font-medium hover:bg-purple-600 transition-colors">
                        ì •ë¦¬í• ë˜ìš”
                    </button>
                </div>
            </div>
        </div>

        <!-- ì§„í–‰ ìƒí™© ì‚¬ì´ë“œë°” -->
        <div class="w-80 bg-white rounded-lg shadow-lg p-6">
            <div class="flex items-center gap-2 mb-4">
                <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center">
                    <span class="text-white text-sm">ğŸ¯</span>
                </div>
                <h2 class="text-lg font-bold">ìŠ¤ë¬´ê³ ê°œ ì§„í–‰ìƒí™©</h2>
            </div>
            
            <div class="mb-4">
                <p class="text-sm text-gray-600">ì§„í–‰: <span id="progressCount">0</span> / 20</p>
            </div>

            <div id="progressList" class="space-y-2 max-h-[600px] overflow-y-auto">
                <!-- ì§„í–‰ ìƒí™©ì´ ì—¬ê¸°ì— ì¶”ê°€ë¨ -->
            </div>

            <div class="mt-6 p-4 bg-yellow-50 rounded-lg">
                <p class="text-sm text-yellow-800">ğŸ’¡ ìƒê°í•˜ê³  íƒêµ¬í•˜ë©° ë‹µì„ ì°¾ì•„ê°€ìš”!</p>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentStep = 0;
        let gameHistory = [];
        let initialQuestion = '';
        let currentStage = 'start'; // start, concepts, questions, thought
        let selectedConcepts = [];
        let currentQuestion = '';
        let stateHistory = []; // ì´ì „ í™”ë©´ ê¸°ëŠ¥ì„ ìœ„í•œ ìƒíƒœ ì €ì¥

        // ê²©ë ¤ ë©˜íŠ¸ ëª©ë¡
        const encouragements = [
            "ì™€, ì‹ ì„ í•œ ì‹œê°ì´ì—ìš”! ğŸŒŸ",
            "ì¢‹ì€ ì§ˆë¬¸ì´ë„¤ìš”! ğŸ‘",
            "ì¬ë¯¸ìˆëŠ” ê´€ì ì´ì—ìš”! ğŸ’¡",
            "ì°½ì˜ì ì¸ ì ‘ê·¼ì´ì—ìš”! âœ¨",
            "ë©‹ì§„ ìƒê°ì´ì—ìš”! ğŸ¯",
            "í˜¸ê¸°ì‹¬ì´ ëŒ€ë‹¨í•´ìš”! ğŸ”",
            "ê¹Šì´ ìˆëŠ” ì§ˆë¬¸ì´ë„¤ìš”! ğŸ¤”",
            "íƒêµ¬ ì •ì‹ ì´ í›Œë¥­í•´ìš”! ğŸŒˆ"
        ];

        function getRandomEncouragement() {
            return encouragements[Math.floor(Math.random() * encouragements.length)];
        }

        function getInitialQuestion() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('q') || 'ì§ˆë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
        }

        function showLoading(message = 'ì§ˆë¬¸ì„ ìƒì„±í•˜ê³  ìˆëŠ” ì¤‘ì…ë‹ˆë‹¤...') {
            document.getElementById('gameState').innerHTML = `
                <div class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600 mx-auto mb-4"></div>
                    <p class="text-lg text-gray-600 font-semibold">${message}</p>
                    <p class="text-sm text-gray-500 mt-2">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”</p>
                </div>
            `;
        }

        function showButtons() {
            document.getElementById('actionButtons').classList.remove('hidden');
        }

        function hideButtons() {
            document.getElementById('actionButtons').classList.add('hidden');
        }

        // API í˜¸ì¶œ - ê°œë…ì–´ ìƒì„±
        async function generateConcepts(previousQuestion = null, userThought = null) {
            try {
                const response = await fetch('/api/generate-concepts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        baseQuestion: initialQuestion,
                        previousQuestion: previousQuestion,
                        userThought: userThought,
                        history: gameHistory
                    })
                });

                if (!response.ok) throw new Error(`API ì˜¤ë¥˜: ${response.status}`);
                const data = await response.json();
                return data.concepts || ["í¬ê¸°", "ìƒ‰ê¹”", "ìœ„ì¹˜", "êµ¬ì¡°", "ê¸°ëŠ¥", "ì¢…ë¥˜", "ì‹œê¸°", "ë°©ë²•"];
            } catch (error) {
                console.error('ê°œë…ì–´ ìƒì„± ì‹¤íŒ¨:', error);
                return ["í¬ê¸°", "ìƒ‰ê¹”", "ìœ„ì¹˜", "êµ¬ì¡°", "ê¸°ëŠ¥", "ì¢…ë¥˜", "ì‹œê¸°", "ë°©ë²•"];
            }
        }

        // API í˜¸ì¶œ - ì§ˆë¬¸ ìƒì„±
        async function generateQuestions(concepts, previousQuestion = null, userThought = null) {
            try {
                const response = await fetch('/api/generate-questions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        baseQuestion: initialQuestion,
                        selectedConcepts: concepts,
                        previousQuestion: previousQuestion,
                        userThought: userThought,
                        previousQuestions: gameHistory.filter(h => h.type === 'question').map(h => h.question)
                    })
                });

                if (!response.ok) throw new Error(`API ì˜¤ë¥˜: ${response.status}`);
                const data = await response.json();
                return data.questions || [];
            } catch (error) {
                console.error('ì§ˆë¬¸ ìƒì„± ì‹¤íŒ¨:', error);
                return [
                    "ì´ê²ƒì˜ êµ¬ì¡°ëŠ” ì–´ë–»ê²Œ ë˜ì–´ ìˆì„ê¹Œ?",
                    "ì´ê²ƒì€ ì–´ë–¤ í™˜ê²½ì— ìˆì„ê¹Œ?",
                    "ì´ê²ƒê³¼ ë¹„ìŠ·í•œ ê²ƒì€ ë¬´ì—‡ì¼ê¹Œ?",
                    "ì´ê²ƒì˜ ì—­í• ì€ ë¬´ì—‡ì¼ê¹Œ?",
                    "ì´ê²ƒì€ ì–´ë–»ê²Œ ì‘ë™í• ê¹Œ?"
                ];
            }
        }

        // ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸
        function updateProgress() {
            document.getElementById('progressCount').textContent = currentStep;
            
            const progressList = document.getElementById('progressList');
            progressList.innerHTML = '';
            
            // ì‹œì‘ ì§ˆë¬¸
            const initialDiv = document.createElement('div');
            initialDiv.className = 'p-3 rounded bg-blue-100 border-2 border-blue-300';
            initialDiv.innerHTML = `<strong class="text-blue-800">ì‹œì‘ ì§ˆë¬¸</strong><br><span class="text-blue-700">${initialQuestion}</span>`;
            progressList.appendChild(initialDiv);
            
            // íˆìŠ¤í† ë¦¬ (ì§ˆë¬¸ê³¼ ìƒê°ë§Œ)
            gameHistory.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'p-2 rounded text-sm';
                
                if (item.type === 'question') {
                    div.className += ' bg-green-100 text-green-800';
                    div.innerHTML = `<strong>ê³ ê°œ ${Math.floor(index/2) + 1}</strong><br>${item.question}`;
                } else if (item.type === 'thought') {
                    div.className += ' bg-purple-100 text-purple-800';
                    div.innerHTML = `<strong>ë‚´ ìƒê°</strong><br>${item.thought}`;
                }
                
                progressList.appendChild(div);
            });

            progressList.scrollTop = progressList.scrollHeight;
        }

        // ê°œë…ì–´ ì„ íƒ í™”ë©´
        async function showConceptSelection(previousQuestion = null, userThought = null) {
            saveState();
            currentStage = 'concepts';
            selectedConcepts = [];
            
            showLoading('ê°œë…ì–´ë¥¼ ìƒì„±í•˜ê³  ìˆëŠ” ì¤‘ì…ë‹ˆë‹¤...');
            hideButtons();
            
            const concepts = await generateConcepts(previousQuestion, userThought);
            
            const gameState = document.getElementById('gameState');
            gameState.innerHTML = `
                <h2 class="text-xl font-bold text-purple-600 mb-6">ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ íŒíŠ¸ë¡œ ë¬´ì—‡ì´ ìˆì„ê¹Œìš”?</h2>
                <div class="grid grid-cols-4 gap-3 mb-4">
                    ${concepts.map((concept, index) => `
                        <div onclick="toggleConcept('${concept}', ${index})" 
                             id="concept-${index}"
                             class="concept-card cursor-pointer bg-amber-50 border-2 border-amber-200 rounded-lg p-4 text-center shadow-md">
                            <p class="font-medium text-gray-700">${concept}</p>
                        </div>
                    `).join('')}
                </div>
                <div class="flex justify-center">
                    <div onclick="handleNoRelation()" 
                         class="concept-card cursor-pointer bg-gray-100 border-2 border-gray-300 rounded-lg p-4 w-48 text-center shadow-md">
                        <p class="font-medium text-gray-600">ê´€ë ¨ì—†ìŒ</p>
                    </div>
                </div>
            `;
            
            showButtons();
        }

        // ê°œë…ì–´ ì„ íƒ í† ê¸€
        function toggleConcept(concept, index) {
            const card = document.getElementById(`concept-${index}`);
            
            if (selectedConcepts.includes(concept)) {
                selectedConcepts = selectedConcepts.filter(c => c !== concept);
                card.classList.remove('selected');
            } else {
                selectedConcepts.push(concept);
                card.classList.add('selected');
            }
        }

        // ê´€ë ¨ì—†ìŒ ì²˜ë¦¬
        async function handleNoRelation() {
            await showConceptSelection(currentQuestion, gameHistory[gameHistory.length - 1]?.thought);
        }

        // 5ê°œ ì§ˆë¬¸ ì„ íƒ í™”ë©´
        async function showQuestionChoices() {
            if (selectedConcepts.length === 0) {
                alert('ìµœì†Œ í•˜ë‚˜ì˜ ê°œë…ì–´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }

            saveState();
            currentStage = 'questions';
            
            showLoading('ì§ˆë¬¸ì„ ìƒì„±í•˜ê³  ìˆëŠ” ì¤‘ì…ë‹ˆë‹¤...');
            hideButtons();
            
            const lastThought = gameHistory.filter(h => h.type === 'thought').pop();
            const questions = await generateQuestions(
                selectedConcepts, 
                currentQuestion,
                lastThought?.thought
            );
            
            const gameState = document.getElementById('gameState');
            gameState.innerHTML = `
                <h2 class="text-xl font-bold text-green-600 mb-4">ì–´ë–¤ ë°©í–¥ìœ¼ë¡œ íƒêµ¬í•´ë³¼ê¹Œìš”?</h2>
                <div class="space-y-3">
                    ${questions.map(q => `
                        <button onclick='selectQuestion(\`${q.replace(/`/g, '\\`').replace(/'/g, "\\'")}\`)' 
                                class="w-full p-4 text-left border-2 border-green-200 rounded-lg hover:bg-green-50 hover:border-green-400 transition-colors">
                            ${q}
                        </button>
                    `).join('')}
                </div>
            `;
            
            showButtons();
        }

        // ì§ˆë¬¸ ì„ íƒ
        function selectQuestion(question) {
            saveState();
            currentStep++;
            currentQuestion = question;
            gameHistory.push({
                type: 'question',
                question: question,
                step: currentStep
            });
            updateProgress();
            
            showThoughtInput(question);
        }

        // ìƒê° ì…ë ¥ í™”ë©´
        function showThoughtInput(question) {
            currentStage = 'thought';
            const encouragement = getRandomEncouragement();
            
            const gameState = document.getElementById('gameState');
            gameState.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                        <p class="font-semibold text-green-800 mb-2">ì„ íƒí•œ ì§ˆë¬¸:</p>
                        <p class="text-green-700 text-lg">${question}</p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-5 rounded-lg border-2 border-yellow-300">
                        <p class="text-2xl font-bold text-orange-600 text-center mb-2">${encouragement}</p>
                        <p class="text-center text-gray-700">ì´ ì§ˆë¬¸ì— ëŒ€í•´ ì–´ë–»ê²Œ ìƒê°í•˜ë‚˜ìš”?</p>
                    </div>
                    
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ì´ ì§ˆë¬¸ì— ëŒ€í•œ ë‹¹ì‹ ì˜ ìƒê°ì´ë‚˜ ì¶”ì¸¡ì„ ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”
                        </label>
                        <textarea 
                            id="userThought" 
                            rows="4" 
                            class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                            placeholder="ì˜ˆ: ì•„ë§ˆë„... / í˜¹ì‹œ... / ë§Œì•½ì—... / ì™œëƒí•˜ë©´..."></textarea>
                    </div>
                </div>
            `;
            
            showButtons();
        }

        // ìƒíƒœ ì €ì¥ (ì´ì „ í™”ë©´ìš©)
        function saveState() {
            stateHistory.push({
                stage: currentStage,
                step: currentStep,
                historyLength: gameHistory.length,
                selectedConcepts: [...selectedConcepts],
                currentQuestion: currentQuestion
            });
        }

        // ì´ì „ í™”ë©´
        function goBack() {
            if (stateHistory.length === 0) {
                alert('ë” ì´ìƒ ëŒì•„ê°ˆ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const previousState = stateHistory.pop();
            
            // ì§„í–‰ìƒí™© ë³µêµ¬
            while (gameHistory.length > previousState.historyLength) {
                gameHistory.pop();
            }
            
            currentStep = previousState.step;
            currentStage = previousState.stage;
            selectedConcepts = previousState.selectedConcepts;
            currentQuestion = previousState.currentQuestion;
            
            updateProgress();
            
            // ì´ì „ í™”ë©´ìœ¼ë¡œ
            if (currentStage === 'concepts') {
                showConceptSelection();
            } else if (currentStage === 'questions') {
                showQuestionChoices();
            } else if (currentStage === 'thought') {
                showThoughtInput(currentQuestion);
            }
        }

        // ê³„ì† ìƒê°í•´ë³´ê¸°
        async function continueThinking() {
            if (currentStage === 'concepts') {
                await showQuestionChoices();
            } else if (currentStage === 'questions') {
                alert('ì§ˆë¬¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
            } else if (currentStage === 'thought') {
                const userThought = document.getElementById('userThought')?.value.trim();
                
                if (!userThought) {
                    alert('ìƒê°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                    return;
                }

                currentStep++;
                gameHistory.push({
                    type: 'thought',
                    thought: userThought,
                    step: currentStep
                });
                updateProgress();
                
                await showConceptSelection(currentQuestion, userThought);
            }
        }

        // ì •ë¦¬í• ë˜ìš”
        function summarize() {
            alert('ì •ë¦¬ í˜ì´ì§€ëŠ” ê³§ ì¶”ê°€ë  ì˜ˆì •ì…ë‹ˆë‹¤!');
        }

        // ê²Œì„ ì´ˆê¸°í™”
        async function initializeGame() {
            initialQuestion = getInitialQuestion();
            document.getElementById('initialQuestion').textContent = initialQuestion;
            document.getElementById('encouragementBox').classList.remove('hidden');
            updateProgress();
            hideButtons();
            
            // ì²« ê°œë…ì–´ ì„ íƒ í™”ë©´ìœ¼ë¡œ
            await showConceptSelection();
        }

        window.onload = initializeGame;
    </script>
</body>
</html>
