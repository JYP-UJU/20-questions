<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë¬´ê³ ê°œ ê²Œì„</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 flex gap-8">
        <!-- ë©”ì¸ ê²Œì„ ì˜ì—­ -->
        <div class="flex-1 max-w-2xl">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h1 class="text-2xl font-bold text-blue-600 mb-6">ì‹œì‘ ì§ˆë¬¸</h1>
                
                <!-- ì´ˆê¸° ì§ˆë¬¸ í‘œì‹œ -->
                <div class="bg-blue-50 p-4 rounded-lg mb-6">
                    <p id="initialQuestion" class="text-lg font-medium">ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>

                <!-- ê²Œì„ ìƒíƒœ -->
                <div id="gameState">
                    <!-- ì—¬ê¸°ì— ê²Œì„ ë‹¨ê³„ë³„ ë‚´ìš©ì´ ë“¤ì–´ê° -->
                </div>
            </div>
        </div>

        <!-- ì§„í–‰ ìƒí™© ì‚¬ì´ë“œë°” -->
        <div class="w-80 bg-white rounded-lg shadow-lg p-6">
            <div class="flex items-center gap-2 mb-4">
                <div class="w-8 h-8 bg-red-500 rounded-full flex items-center justify-center">
                    <span class="text-white text-sm">ğŸ¯</span>
                </div>
                <h2 class="text-lg font-bold">ìŠ¤ë¬´ê³ ê°œ ì§„í–‰ìƒí™©</h2>
            </div>
            
            <div class="mb-4">
                <p class="text-sm text-gray-600">ì§„í–‰: <span id="progressCount">0</span> / 20</p>
            </div>

            <div id="progressList" class="space-y-2">
                <!-- ì§„í–‰ ìƒí™©ì´ ì—¬ê¸°ì— ì¶”ê°€ë¨ -->
            </div>

            <div class="mt-6 p-4 bg-yellow-50 rounded-lg">
                <p class="text-sm text-yellow-800">ğŸ’¡ ì§ˆë¬¸ì„ í†µí•´ íƒêµ¬ë¥¼ ê¹Šì´ ìˆê²Œ í•´ë³´ì„¸ìš”!</p>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentStep = 0;
        let gameHistory = [];
        let initialQuestion = '';

        // URLì—ì„œ ì´ˆê¸° ì§ˆë¬¸ ê°€ì ¸ì˜¤ê¸°
        function getInitialQuestion() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('q') || 'ì§ˆë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
        }

        // Claude API í˜¸ì¶œ
        async function callClaudeAPI(contextQuestion, userAnswer = null) {
            try {
                // ì´ì „ ëŒ€í™” ë§¥ë½ êµ¬ì„±
                const recentHistory = gameHistory.slice(-3); // ìµœê·¼ 3ê°œë§Œ
                let contextText = '';
                
                if (userAnswer) {
                    contextText = `
ì´ì „ ì§ˆë¬¸: "${contextQuestion}"
ì‚¬ìš©ì ë‹µë³€: "${userAnswer}"

ìœ„ ë‹µë³€ì„ ë°”íƒ•ìœ¼ë¡œ ë” ê¹Šì´ íƒêµ¬í•  ìˆ˜ ìˆëŠ” í›„ì† ì§ˆë¬¸ 5ê°œë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.`;
                } else {
                    contextText = `"${contextQuestion}"ì— ëŒ€í•œ ì²« íƒêµ¬ ì§ˆë¬¸ 5ê°œë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.`;
                }

                const response = await fetch('/api/generate-questions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        baseQuestion: initialQuestion,
                        contextQuestion: contextQuestion,
                        userAnswer: userAnswer,
                        previousQuestions: gameHistory.map(h => h.question || h.answer).filter(Boolean),
                        stepNumber: currentStep + 1
                    })
                });

                if (!response.ok) {
                    throw new Error(`API ì˜¤ë¥˜: ${response.status}`);
                }

                const data = await response.json();
                return data.questions || [];
            } catch (error) {
                console.error('Claude API ì˜¤ë¥˜:', error);
                return [
                    "ì´ê²ƒì€ ë¬´ì—‡ìœ¼ë¡œ ë§Œë“¤ì–´ì ¸ ìˆì„ê¹Œ?",
                    "ì´ê²ƒì˜ í¬ê¸°ëŠ” ì–´ëŠ ì •ë„ì¼ê¹Œ?", 
                    "ì´ê²ƒì€ ì–´ë””ì—ì„œ ë°œê²¬ë ê¹Œ?",
                    "ì´ê²ƒì€ ì–´ë–¤ íŠ¹ì§•ì´ ìˆì„ê¹Œ?",
                    "ì´ê²ƒì€ ë¬´ì—‡ì— ì‚¬ìš©ë ê¹Œ?"
                ];
            }
        }

        // ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸
        function updateProgress() {
            document.getElementById('progressCount').textContent = currentStep;
            
            const progressList = document.getElementById('progressList');
            progressList.innerHTML = '';
            
            // ì‹œì‘ ì§ˆë¬¸ì„ ë§¨ ìœ„ì— íŒŒë€ìƒ‰ìœ¼ë¡œ í‘œì‹œ
            const initialDiv = document.createElement('div');
            initialDiv.className = 'p-3 rounded bg-blue-100 border-2 border-blue-300';
            initialDiv.innerHTML = `<strong class="text-blue-800">ì‹œì‘ ì§ˆë¬¸</strong><br><span class="text-blue-700">${initialQuestion}</span>`;
            progressList.appendChild(initialDiv);
            
            // ë‚˜ë¨¸ì§€ íˆìŠ¤í† ë¦¬
            gameHistory.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'p-2 rounded text-sm';
                
                if (item.type === 'question') {
                    div.className += ' bg-green-100 text-green-800';
                    div.innerHTML = `<strong>ê³ ê°œ ${index + 1}</strong><br>${item.question}`;
                } else if (item.type === 'answer') {
                    div.className += ' bg-purple-100 text-purple-800';
                    div.innerHTML = `<strong>ê³ ê°œ ${index + 1} (ë‚´ ìƒê°)</strong><br>${item.answer}`;
                }
                
                progressList.appendChild(div);
            });
        }

        // 5ê°œ ì„ íƒì§€ í‘œì‹œ
        function showQuestionChoices(questions, contextQuestion) {
            const gameState = document.getElementById('gameState');
            
            gameState.innerHTML = `
                <h2 class="text-xl font-bold text-green-600 mb-4">ì–´ë–¤ ë°©í–¥ìœ¼ë¡œ íƒêµ¬í•´ë³¼ê¹Œìš”?</h2>
                <div class="space-y-3">
                    ${questions.map((q, index) => `
                        <button onclick='selectQuestion(\`${q.replace(/`/g, '\\`')}\`, \`${contextQuestion.replace(/`/g, '\\`')}\`)' 
                                class="w-full p-4 text-left border border-green-200 rounded-lg hover:bg-green-50 transition-colors">
                            ${q}
                        </button>
                    `).join('')}
                </div>
            `;
        }

        // ì§ˆë¬¸ ì„ íƒ ì²˜ë¦¬
        function selectQuestion(question, contextQuestion) {
            currentStep++;
            gameHistory.push({
                type: 'question',
                question: question,
                contextQuestion: contextQuestion,
                step: currentStep
            });
            
            updateProgress();
            showAnswerInput(question);
        }

        // ë‹µë³€ ì…ë ¥ í™”ë©´ í‘œì‹œ
        function showAnswerInput(question) {
            const gameState = document.getElementById('gameState');
            
            gameState.innerHTML = `
                <h2 class="text-xl font-bold text-orange-600 mb-4">ì´ì œ ë‹¹ì‹ ì´ ì§ˆë¬¸í•´ë³´ì„¸ìš”!</h2>
                <div class="bg-orange-50 p-4 rounded-lg mb-4">
                    <p class="font-medium mb-2">ì„ íƒí•œ íƒêµ¬ ë°©í–¥:</p>
                    <p class="text-orange-700">${question}</p>
                </div>
                <div class="space-y-4">
                    <label class="block text-sm font-medium text-gray-700">
                        íƒêµ¬í•˜ë©´ì„œ ìƒˆë¡­ê²Œ ê¶ê¸ˆí•œ ê²ƒì„ ì§ˆë¬¸ìœ¼ë¡œ ë§Œë“¤ì–´ë³´ì„¸ìš”...
                    </label>
                    <textarea 
                        id="userAnswer" 
                        rows="4" 
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                        placeholder="ì˜ˆ: ì´ ë°©í–¥ìœ¼ë¡œ ìƒê°í•´ë³´ë‹ˆ ë˜ ë‹¤ë¥¸ ê¶ê¸ˆí•œ ì ì´ ìƒê²¼ì–´ìš”..."></textarea>
                    <button 
                        onclick="submitAnswer()" 
                        class="w-full bg-orange-500 text-white py-3 px-6 rounded-lg font-medium hover:bg-orange-600 transition-colors">
                        ì§ˆë¬¸ ì œì¶œí•˜ê³  ê³„ì† íƒêµ¬í•˜ê¸°!
                    </button>
                </div>
            `;
        }

        // ë‹µë³€ ì œì¶œ ì²˜ë¦¬
        async function submitAnswer() {
            const userAnswer = document.getElementById('userAnswer').value.trim();
            
            if (!userAnswer) {
                alert('ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            currentStep++;
            const lastQuestion = gameHistory[gameHistory.length - 1].question;
            
            gameHistory.push({
                type: 'answer',
                answer: userAnswer,
                step: currentStep
            });
            
            updateProgress();
            
            // ë¡œë”© ìƒíƒœ
            document.getElementById('gameState').innerHTML = `
                <div class="text-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                    <p class="mt-2 text-gray-600">ë‹¤ìŒ íƒêµ¬ ë°©í–¥ì„ ìƒê° ì¤‘...</p>
                </div>
            `;

            // ìƒˆë¡œìš´ ì§ˆë¬¸ ìƒì„± (ì§ì „ ì§ˆë¬¸ê³¼ ë‹µë³€ ê¸°ë°˜)
            try {
                const questions = await callClaudeAPI(lastQuestion, userAnswer);
                showQuestionChoices(questions, lastQuestion);
            } catch (error) {
                console.error('ìƒˆ ì§ˆë¬¸ ìƒì„± ì‹¤íŒ¨:', error);
                showQuestionChoices([
                    "ë” êµ¬ì²´ì ìœ¼ë¡œ ì•Œì•„ë³¼ê¹Œ?",
                    "ë‹¤ë¥¸ ê´€ì ì—ì„œ ë³´ë©´?",
                    "ì‹¤ì œ ì‚¬ë¡€ëŠ”?",
                    "ë¹„êµí•´ë³´ë©´?",
                    "ì‘ìš©í•  ìˆ˜ ìˆì„ê¹Œ?"
                ], lastQuestion);
            }
        }

        // ê²Œì„ ì´ˆê¸°í™”
        async function initializeGame() {
            initialQuestion = getInitialQuestion();
            document.getElementById('initialQuestion').textContent = initialQuestion;
            
            updateProgress(); // ì‹œì‘ ì§ˆë¬¸ í‘œì‹œ
            
            // ì²« ë²ˆì§¸ ì§ˆë¬¸ë“¤ ìƒì„±
            const questions = await callClaudeAPI(initialQuestion);
            showQuestionChoices(questions, initialQuestion);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ê²Œì„ ì‹œì‘
        window.onload = initializeGame;
    </script>
</body>
</html>
